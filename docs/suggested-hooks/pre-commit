#!/usr/bin/env bash
# Purpose: Provide a conservative pre-commit gate for untrusted or mixed-trust agents.
# Exports: none.
# Role: Local quality gate that formats staged Go files, runs quick tests, and prints actionable reminders.
# Invariants: Never parses stdin; never commits; fails the commit on formatting/tooling/test failures.
# Notes: This hook is intentionally repo-aware (Taskfile/go tooling) and prints warnings for doc drift.

set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"

echo >&2
echo "# checklist (commit)" >&2
echo "# - If you changed ergo plans/tasks: stage the log: git add .ergo/plans.jsonl (or events.jsonl if using legacy name)" >&2
echo "# - Before pushing: run task ci (or let pre-push run it)" >&2
echo >&2

# Staged file inventory (used for decisions and warnings below).
mapfile -t staged_files < <(git diff --cached --name-only --diff-filter=ACM || true)

# Format only staged Go files, then restage them.
mapfile -t staged_go_files < <(printf '%s\n' "${staged_files[@]}" | grep -E '\\.go$' || true)
if (( ${#staged_go_files[@]} > 0 )); then
  gofmt -w "${staged_go_files[@]}"
  git add -- "${staged_go_files[@]}"
fi

# Warn (do not fail) if ergo tasks/log changed but plans/events file is not staged.
# Check for plans.jsonl first (new), then events.jsonl (legacy)
ergo_log_file=""
if [[ -f "$repo_root/.ergo/plans.jsonl" ]]; then
  ergo_log_file="plans.jsonl"
elif [[ -f "$repo_root/.ergo/events.jsonl" ]]; then
  ergo_log_file="events.jsonl"
fi

if [[ -n "$ergo_log_file" ]]; then
  if ! git diff --cached --name-only --diff-filter=ACM | grep -q "^\\.ergo/$ergo_log_file\$"; then
    if git diff --name-only | grep -q "^\\.ergo/$ergo_log_file\$"; then
      echo "warning: .ergo/$ergo_log_file changed but is not staged" >&2
      echo "action: git add .ergo/$ergo_log_file" >&2
      echo "action: close finished tasks (ergo set <id> --state done)" >&2
    fi
  fi
fi

# Quick checks: run unit tests only when Go code/config changed (CI parity lives in pre-push).
has_go_changes=false
for f in "${staged_files[@]}"; do
  case "$f" in
    *.go|go.mod|go.sum|Taskfile.yml) has_go_changes=true ;;
  esac
done
if [[ "$has_go_changes" == "true" ]]; then
  go test ./...
fi

echo "ok: pre-commit checks passed; safe to commit" >&2
